# Questo file si pone l'obiettivo di organizzare meglio il file "parse_simone.py"
# Organizza meglio il codice, e prova a renderlo più efficace.
html_content = '''
<div class="history ticket" id="ticket-26588-history">
<div class="titlebox" id="">
  <div class="titlebox-title">
    <span class="widget"><a href="#" onclick="return rollup('TitleBox\x2D\x2D\x5FHelpers\x5FTicketHistory\x2D\x2D\x2D\x2D\x2D\x2DSGlzdG9yeQ\x5F\x5F\x2D\x2D\x2D0');" title="Toggle visibility"></a></span>
    <span class="left">History</span>
    <span class="right">                <a href="#" data-direction="open" onclick="return toggle_all_folds(this, 'Show\x20all\x20quoted\x20text', 'Hide\x20all\x20quoted\x20text');">Show all quoted text</a> — <a href="?ForceShowHistory=1;ShowHeaders=1;id=26588#ticket-26588-history">Show full headers</a>    </span>
  </div>
  <div class="titlebox-content " id="TitleBox--_Helpers_TicketHistory------SGlzdG9yeQ__---0">



<div class="history-container">



<div class="transaction Ticket-transaction message odd" data-transaction-id="901610">
  <div class="metadata">
    <span class="type">
      <a name="txn-901610"       href="Display.html?id=26588#txn-901610"       >#</a>
    </span>
    <span class="date">Tue May 17 11:00:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="61142"><a href="/User/Summary.html?id=61142">Marina Filip <marina.filip@physics.ox.ac.uk></a></span> - Ticket created
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="Update.html?id=26588&QuoteTransaction=901610&Action=Respond" class="reply-link">Reply</a>] [<a href="Update.html?id=26588&QuoteTransaction=901610&Action=Comment" class="comment-link">Comment</a>]</span>
  </div>

  <div class="content">
<table>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value ">
       "superc@cineca.it" <superc@cineca.it></td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value ">
       "Marina Filip" <marina.filip@physics.ox.ac.uk></td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value ">
       Tue, 17 May 2022 08:58:14 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value ">
       Fw: x509 certificate is expiring</td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="Attachment/901610/791490/">
Download (untitled)</a> / <a href="Attachment/WithHeaders/791490">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 739B</span>
</div>
<div class="messagebody">
</div>
<div class="downloadattachment">
<a href="Attachment/901610/791491/">
Download (untitled)</a> / <a href="Attachment/WithHeaders/791491">with headers</a>
<br />
<span class="downloadcontenttype">text/html 2.1KiB</span>
</div>
<div class="messagebody">
<div class="message-stanza"><div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
Dear Support Team, <br>
</div>


<div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
<br>
</div>


<div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
I've just received this email and would like to renew this certificate. <br>
</div>


<div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
<br>
</div>


<div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
With many thanks, <br>
</div>


<div style="font-family: Calibri, Arial, Helvetica, sans-serif; font-size: 12pt; color: rgb(0, 0, 0);">
Marina<br>
</div>


<div></div>


<hr>
<div dir="ltr"><font face="Calibri, sans-serif" style="font-size:11pt" color="#000000"><b>From:</b> certificate-administrator-hpc-cineca-rp02@master-ext.pico.cineca.it <certificate-administrator-hpc-cineca-rp02@master-ext.pico.cineca.it><br>
<b>Sent:</b> 17 May 2022 07:15<br>
<b>To:</b> Marina Filip <marina.filip@physics.ox.ac.uk><br>
<b>Subject:</b> x509 certificate is expiring</font>
<div> </div>
</div>
<div><font size="2"><span style="font-size:11pt;">
<div>Dear User,<br>
your x509 certificate issued by HPC-CINECA is expiring. <br>
This email will be sent 15, 7, 4, 2, 1 days before the expiring date. <br>
<br>
If you want a new certificate, please contact HPC User Support@CINECA <br>
sending an email to superc@cineca.it. <br>
<br>
Please don't reply to this email. <br>
<br>
Best Regards <br>
CINECA HPC Certificate Administrator<br>
</div>
</span></font></div>



</div></div>
</div>
  </div>
</div>


<div class="transaction Ticket-transaction other even" data-transaction-id="901617">
  <div class="metadata">
    <span class="type">
      <a name="txn-901617"       href="Display.html?id=26588#txn-901617"       >#</a>
    </span>
    <span class="date">Tue May 17 11:00:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Outgoing email recorded
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="ShowEmailRecord.html?id=26588&Transaction=901617&Attachment=791498" target="_blank">Show</a>]</span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction other odd" data-transaction-id="901618">
  <div class="metadata">
    <span class="type">
      <a name="txn-901618"       href="Display.html?id=26588#txn-901618"       >#</a>
    </span>
    <span class="date">Tue May 17 11:00:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Outgoing email recorded
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="ShowEmailRecord.html?id=26588&Transaction=901618&Attachment=791501" target="_blank">Show</a>]</span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction people even" data-transaction-id="901746">
  <div class="metadata">
    <span class="type">
      <a name="txn-901746"       href="Display.html?id=26588#txn-901746"       >#</a>
    </span>
    <span class="date">Tue May 17 12:09:06 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Taken
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="901750">
  <div class="metadata">
    <span class="type">
      <a name="txn-901750"       href="Display.html?id=26588#txn-901750"       >#</a>
    </span>
    <span class="date">Tue May 17 12:09:09 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Status changed from 'new' to 'open'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction links even" data-transaction-id="904516">
  <div class="metadata">
    <span class="type">
      <a name="txn-904516"       href="Display.html?id=26588#txn-904516"       >#</a>
    </span>
    <span class="date">Fri May 20 10:54:52 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Reference to <a href="https://tts.hpc.cineca.it/Ticket/Display.html?id=14052">https://tts.hpc.cineca.it/Ticket/Display.html?id=14052</a> added
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="904526">
  <div class="metadata">
    <span class="type">
      <a name="txn-904526"       href="Display.html?id=26588#txn-904526"       >#</a>
    </span>
    <span class="date">Fri May 20 10:55:43 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Queue changed from HPC-US-FIRST to HPC-US-SECOND
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics even" data-transaction-id="904535">
  <div class="metadata">
    <span class="type">
      <a name="txn-904535"       href="Display.html?id=26588#txn-904535"       >#</a>
    </span>
    <span class="date">Fri May 20 10:55:57 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Status changed from 'open' to 'resolved'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="904564">
  <div class="metadata">
    <span class="type">
      <a name="txn-904564"       href="Display.html?id=26588#txn-904564"       >#</a>
    </span>
    <span class="date">Fri May 20 11:01:29 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Status changed from 'resolved' to 'open'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction links even" data-transaction-id="904618">
  <div class="metadata">
    <span class="type">
      <a name="txn-904618"       href="Display.html?id=26588#txn-904618"       >#</a>
    </span>
    <span class="date">Fri May 20 11:22:56 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Reference to <a href="https://tts.hpc.cineca.it/Ticket/Display.html?id=14052">https://tts.hpc.cineca.it/Ticket/Display.html?id=14052</a> deleted
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction links odd" data-transaction-id="904662">
  <div class="metadata">
    <span class="type">
      <a name="txn-904662"       href="Display.html?id=26588#txn-904662"       >#</a>
    </span>
    <span class="date">Fri May 20 11:28:17 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Reference to <a href="https://tts.hpc.cineca.it/Ticket/Display.html?id=26676">https://tts.hpc.cineca.it/Ticket/Display.html?id=26676</a> added
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction message even" data-transaction-id="906714">
  <div class="metadata">
    <span class="type">
      <a name="txn-906714"       href="Display.html?id=26588#txn-906714"       >#</a>
    </span>
    <span class="date">Tue May 24 12:35:00 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Correspondence added
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="Update.html?id=26588&QuoteTransaction=906714&Action=Respond" class="reply-link">Reply</a>] [<a href="Update.html?id=26588&QuoteTransaction=906714&Action=Comment" class="comment-link">Comment</a>]</span>
  </div>

  <div class="content">
<div class="downloadattachment">
<a href="Attachment/906714/795947/">
Download (untitled)</a> / <a href="Attachment/WithHeaders/795947">with headers</a>
<br />
<span class="downloadcontenttype">text/html 140B</span>
</div>
<div class="messagebody">
<div class="message-stanza"><div>Dear Marina,<br />

<br />

your certificate has been renewed.<br />

<br />

Best regards,<br />

SilviaG<br />

<br />

<br />

 </div>


</div></div>
  </div>
</div>


<div class="transaction Ticket-transaction other odd" data-transaction-id="906715">
  <div class="metadata">
    <span class="type">
      <a name="txn-906715"       href="Display.html?id=26588#txn-906715"       >#</a>
    </span>
    <span class="date">Tue May 24 12:35:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Outgoing email recorded
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="ShowEmailRecord.html?id=26588&Transaction=906715&Attachment=795948" target="_blank">Show</a>]</span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction other even" data-transaction-id="906716">
  <div class="metadata">
    <span class="type">
      <a name="txn-906716"       href="Display.html?id=26588#txn-906716"       >#</a>
    </span>
    <span class="date">Tue May 24 12:35:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Outgoing email recorded
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="ShowEmailRecord.html?id=26588&Transaction=906716&Attachment=795951" target="_blank">Show</a>]</span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="906720">
  <div class="metadata">
    <span class="type">
      <a name="txn-906720"       href="Display.html?id=26588#txn-906720"       >#</a>
    </span>
    <span class="date">Tue May 24 12:35:05 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Status changed from 'open' to 'resolved'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction message even" data-transaction-id="909031">
  <div class="metadata">
    <span class="type">
      <a name="txn-909031"       href="Display.html?id=26588#txn-909031"       >#</a>
    </span>
    <span class="date">Thu May 26 15:20:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="61142"><a href="/User/Summary.html?id=61142">Marina Filip <marina.filip@physics.ox.ac.uk></a></span> - Correspondence added
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="Update.html?id=26588&QuoteTransaction=909031&Action=Respond" class="reply-link">Reply</a>] [<a href="Update.html?id=26588&QuoteTransaction=909031&Action=Comment" class="comment-link">Comment</a>]</span>
  </div>

  <div class="content">
<table>
  <tr>
    <td align="right" class="message-header-key">Subject:</td>
    <td class="message-header-value ">
       Re: [tts-hpc #26588] Fw: x509 certificate is expiring</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">To:</td>
    <td class="message-header-value ">
       "tts-hpc-usersupport@cineca.it" <tts-hpc-usersupport@cineca.it></td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">Date:</td>
    <td class="message-header-value ">
       Thu, 26 May 2022 13:17:59 +0000</td>
  </tr>
  <tr>
    <td align="right" class="message-header-key">From:</td>
    <td class="message-header-value ">
       "Marina Filip" <marina.filip@physics.ox.ac.uk></td>
  </tr>
</table>
<div class="messageattachments">
<div class="downloadattachment">
<a href="Attachment/909031/798026/">
Download (untitled)</a> / <a href="Attachment/WithHeaders/798026">with headers</a>
<br />
<span class="downloadcontenttype">text/plain 386B</span>
</div>
<div class="messagebody">
</div>
<div class="downloadattachment">
<a href="Attachment/909031/798027/">
Download (untitled)</a> / <a href="Attachment/WithHeaders/798027">with headers</a>
<br />
<span class="downloadcontenttype">text/html 934B</span>
</div>
<div class="messagebody">
<div class="message-stanza"><div>Thank you!</div>


<div><br>
</div>


<div>Marina</div>


<div><br>
</div>


<div>Get <a href="https://aka.ms/AAb9ysg">
Outlook for Android</a></div>


<hr>
<div dir="ltr"><font face="Calibri, sans-serif" style="font-size:11pt" color="#000000"><b>From:</b> Silvia Giuliani via RT <tts-hpc-usersupport@cineca.it><br>
<b>Sent:</b> Tuesday, May 24, 2022 11:35:01 AM<br>
<b>To:</b> Marina Filip <marina.filip@physics.ox.ac.uk><br>
<b>Subject:</b> [tts-hpc #26588] Fw: x509 certificate is expiring</font>
<div> </div>
</div>
<div>
<div>Dear Marina,<br>
<br>
your certificate has been renewed.<br>
<br>
Best regards,<br>
SilviaG<br>
<br>
<br>
 </div>
</div>



</div></div>
</div>
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="909032">
  <div class="metadata">
    <span class="type">
      <a name="txn-909032"       href="Display.html?id=26588#txn-909032"       >#</a>
    </span>
    <span class="date">Thu May 26 15:20:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Status changed from 'resolved' to 'open'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction other even" data-transaction-id="909033">
  <div class="metadata">
    <span class="type">
      <a name="txn-909033"       href="Display.html?id=26588#txn-909033"       >#</a>
    </span>
    <span class="date">Thu May 26 15:20:01 2022</span>
    <span class="description">
      <span class="user" data-user-id="1">The RT System itself</span> - Outgoing email recorded
    </span>
    <span class="time-taken"></span>
    <span class="actions">[<a href="ShowEmailRecord.html?id=26588&Transaction=909033&Attachment=798028" target="_blank">Show</a>]</span>
  </div>

  <div class="content">
  </div>
</div>


<div class="transaction Ticket-transaction basics odd" data-transaction-id="913895">
  <div class="metadata">
    <span class="type">
      <a name="txn-913895"       href="Display.html?id=26588#txn-913895"       >#</a>
    </span>
    <span class="date">Mon Jun 06 11:42:20 2022</span>
    <span class="description">
      <span class="user" data-user-id="163"><a href="/User/Summary.html?id=163">sgiulian (Silvia Giuliani)</a></span> - Status changed from 'open' to 'resolved'
    </span>
    <span class="time-taken"></span>
  </div>

  <div class="content">
  </div>
</div>





</div>
    <hr class="clear" />
  </div>
</div>




</div>

<script type="text/javascript">ReplaceUserReferences()</script>
'''
# se prendo fino alla riga 350 del testo, funziona. Poi prendono il blocco dopo dice che c'è un none type. Eppure runnandolo da solo sembra funzionare. Non capisco bene cosa ci sia che non va...
import os
import json
from bs4 import BeautifulSoup
import re
from datetime import datetime
from datetime import datetime
from dateutil import parser

from anonymize_data import consistent_anonimization


def compute_date_difference(date1_str, date2_str):
    '''
    This function takes as input two dates. It sorts them in descending order,
    and computes the time difference between the two
    '''
    # Formato della data
    date_format = "%a %b %d %H:%M:%S %Y"
    
    # Conversione delle stringhe in oggetti datetime
    date1 = datetime.strptime(date1_str, date_format)
    date2 = datetime.strptime(date2_str, date_format)
    
    # Assicurarsi che date1 sia sempre precedente a date2
    if date1 > date2:
        date1, date2 = date2, date1
    
    # Calcolo della differenza
    delta = date2 - date1
    
    # Estrazione dei giorni, ore e minuti
    days = delta.days
    hours, remainder = divmod(delta.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)
    
    return f"{days} days, {hours} hours, {minutes} minutes"
  
def extract_email(text):
    # Regex che cerca un pattern di nome seguito da un indirizzo email tra < e >
    match = re.search(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', text)
    if match:
        email = match.group(0).strip()  # Estrae l'email
        return email
    return None

def check_if_email(string):
    email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    
    # Use re.match() to check if the email matches the pattern
    if re.match(email_pattern, string):
        return True
    else:
        return False

def remove_endings(body_text):
    '''
    Questa funzione cerca il pattern "Show quoted text" nell'email e rimuove tutto ciò che segue,
    inclusa la stringa stessa. Rimuove anche le righe che iniziano con "Il ... ha scritto" e "On ... wrote",
    presumendo che siano citazioni di messaggi precedenti.

    Args:
    body_text (str): Il contenuto HTML o testuale dell'email da processare.

    Returns:
    str: Il contenuto modificato senza il testo quotato e senza le linee di citazione tipiche.
    '''
    
    # Crea un pattern regex per trovare "Show quoted text" e tutto ciò che segue fino alla fine del contenuto
    pattern_show = r"Show quoted text.*"
    body_text = re.sub(pattern_show, "", body_text, flags=re.DOTALL)
    
    # Mandiamo a capo la stringa di "Il ... ha scritto:"
    pattern = r"^(Il .*?20\d{2}.*? ha scritto:)$"
    body_text = re.sub(pattern, r"\n\1", body_text) #

    # Mandiamo a capo la stringa di "On ... wrote:"
    pattern = r"(On .*?(?:\d{2}/\d{2}/\d{2}|\d{2}.\d{2}.\d{2}|20\d{2}).*? wrote:)" # r"(On .*?(?:\d{2}/\d{2}/\d{2}|20\d{2}).*? wrote:)
    body_text = re.sub(pattern, r"\n\1", body_text)
  
    # Rimuovi il "Il giorno tot X ha scritto:"
    pattern =  r"^(Il .*?20\d{2}.*? ha scritto:)$"
    body_text = re.sub(pattern, "", body_text, flags=re.MULTILINE)
          
    # Rimuovi il "On ... wrote:"
    pattern = r"^(On\s+.*?(?:\d{2}/\d{2}/\d{2}|\d{2}\.\d{2}\.\d{2}|20\d{2}).*?\s+wrote:)"  #r"^(On .*?20\d{2}.*? wrote:)$"
    body_text = re.sub(pattern, "", body_text, flags=re.MULTILINE|re.DOTALL)
    
    return body_text

def extract_name_opener(content):
    '''Often the opener of the ticket has the following format:
    username (Name Surname). This functions extracts the name of the opener'''
    # Verifica se il contenuto ha la struttura username (nome cognome)
    if re.match(r'^\w+\s\([a-zA-Z\s\.]+\)$', content):
        # Estrae il contenuto tra parentesi
        match = re.search(r'\((.*?)\)', content)
        if match:
            testo = match.group(1)
            # Pulisce il contenuto eliminando singole lettere seguite da un punto
            parole = testo.split()
            parole_pulite = [parola for parola in parole if not (len(parola) == 2 and parola[1] == '.')]
            return ' '.join(parole_pulite)
    return content

def extract_username(content):
    '''This is to be read after extract_name_opener.
    Since the opener is often in the format "username (Name Surname)",
    this function extacts the username of the opener'''
    # Verifica se il contenuto ha la struttura username (nome cognome)
    if re.match(r'^\w+\s\([a-zA-Z\s\.]+\)$', content):
        # Estrae lo username prima della parentesi
        username = re.match(r'^(\w+)\s', content).group(1)
        return username
    return None

def extract_emails(html_content):
  '''
  This function is the main parser of the HTML content.
  It takes as input the HTML of the entire ticket. It then extracts all the emails one by one.
  The emails are stored in a list. The list contains not only body of the email, but also some
  metadata, such as: ID, date, authors, time from previous email, status, length...
  '''
  emails = []
  email_id = 0
  opener = None
  taken_by = 'Not yet assigned'
  last_time_email = None
  who = None
  current_status = 'new'
  to = None
  from_ = None
  from_email = None
  subject = None
  
  Author = None
  Username = None
  
  soup = BeautifulSoup(html_content, 'html.parser')
  target_divs = soup.find_all('div', class_=['transaction Ticket-transaction message odd', # messaggio
                                             'transaction Ticket-transaction message even', # messaggio
                                             'transaction Ticket-transaction basics even',
                                             'transaction Ticket-transaction basics odd']) # in background, il ticket è preso in carico e si cambia lo status
        
  for idx, div in enumerate(target_divs):
    
    # Case 1. Email, metadata and actual text
    if 'message odd' in " ".join(div.get('class', [])):        
        metadata_div = div.find('div', class_='metadata')
        if metadata_div:
          date_div = metadata_div.find('span', class_='date')
          date = date_div.get_text(strip=True) # Data di apertura del ticket
            
          description_span = div.find('span', class_='description')
          if description_span:
            author_div = metadata_div.find('span', class_='user')
            author = author_div.get_text(strip=True)
            author_name_surname = extract_name_opener(author) # Name Surname
            author_username = extract_username(author) # nsurname, ma può essere None se non era presente nel nome originale
            
            if not Author:
              # Se la variabile Author era ancora None, significa che non avevamo ancora incontrato il nome del'autore.
              # Pertanto, colui o colei che apre la mail verrà segnato/a come autore/autrice.
              # Stessa cosa con lo Username
              Author = author_name_surname
            if not Username:  
              Username = author_username
            
            author_email_a_tag = str(author_div.find('a'))
            if from_email is None:
              from_email = extract_email(author_email_a_tag) # Email di Author

            if not opener:
              '''Se la variabile "author" è ancora None, significa che è la prima mail che incontriamo.
              Quindi, l'autore della primissima mail verrà considerato l'opener del ticket'''
              opener = author
              
            if author == opener:
              who = 'user'
            else:
              who = 'support'  
          
        table = div.find('div', class_='content').find('table')
        if table:
          rows = table.find_all('tr')
          for row in rows:
            key, value = row.find_all('td')
            if key.text.strip() == "To:":
                to = value.text.strip()
            elif key.text.strip() == "From:":
                from_ = value.text.strip()
            elif key.text.strip() == "Subject:":
                subject = value.text.strip()
                
        message_stanza = div.find('div', class_='message-stanza')   
        
        message_stanza = div.find('div', class_='message-stanza')
        if message_stanza:
            desired_text = ''
            
            cutoff_element = message_stanza.find('div', class_='message-stanza-folder')

            if cutoff_element:
                for elem in message_stanza.children:
                    if elem == cutoff_element:
                        break
                    if isinstance(elem, str):
                        desired_text += elem.strip() + ' '
                    else:
                        desired_text += elem.get_text(separator=' ', strip=True) + ' '
            else:
                desired_text = message_stanza.get_text(separator=' ', strip=True)

            message_text = desired_text.strip()
        else:
            message_text = ''

        
        if last_time_email:
          time_diff = compute_date_difference(date, last_time_email)
        else:
          time_diff = None 
      
        email_dict = {'@@ID_email': email_id,
                      '@@Date': date,
                      '@@To': to,
                      '@@Who': who,
                      '@@Author_Name': Author, #from_, # si chiamava From
                      '@@Author_username': Username, # questo è nuovo 
                      '@@Author_email': from_, #from_email, # si chiamava Email_author
                      '@@Subject': subject,
                      '@@Length_mail': len(message_text),
                      '@@Taken_by': taken_by,
                      '@@Status': current_status,
                      '@@Time_from_previous': time_diff,
                      '@@Body': remove_endings(message_text),
                      }
        emails.append(email_dict)
                
        email_id += 1
        last_time_email = date
        
    # Case 2. This contains informatin not directly reported in the body of the email    
    elif 'basics even' in " ".join(div.get('class', [])):
        '''Ticket preso in carico, aggiornamento dello status'''
        description_span = div.find('span', class_='description')
        
        if description_span and "Status changed from" in description_span.text:
          status_change_match = re.search(r"Status changed from '(\w+)' to '(\w+)'", description_span.text)
          if status_change_match:
            current_status = status_change_match.group(2).lower()

          user_span = description_span.find('span', class_='user')
          if user_span:
            if (taken_by == 'Not yet assigned') and (user_span.get_text(strip=True) != 'The RT System itself'): #user_span.get_text(strip=True) != 
              taken_by = user_span.get_text(strip=True)           
              
    # Case 3. Similar to case 2.        
    elif 'basics odd' in " ".join(div.get('class', [])):       
      '''Ticket preso in carico, aggiornamento dello status'''
      description_span = div.find('span', class_='description')
            
      if description_span and "Status changed from" in description_span.text:
        status_change_match = re.search(r"Status changed from '(\w+)' to '(\w+)'", description_span.text)
        if status_change_match:
          current_status = status_change_match.group(2).lower()

        user_span = description_span.find('span', class_='user')
        if user_span:
          if (taken_by == 'Not yet assigned') and (user_span.get_text(strip=True) != 'The RT System itself'): #user_span.get_text(strip=True) != 
            taken_by = user_span.get_text(strip=True) 
                                    
    # Case 4, similar to case 1. Email, metadata and actual text            
    elif 'message even' in " ".join(div.get('class', [])):
        '''Risposta di user support'''
        
        metadata_div = div.find('div', class_='metadata')
        if metadata_div:
          date_div = metadata_div.find('span', class_='date')
          date = date_div.get_text(strip=True)
            
          description_span = div.find('span', class_='description')
          if description_span:
            author_div = metadata_div.find('span', class_='user')
            author = author_div.get_text(strip=True)
            if not opener:
              '''Se la variabile "author" è ancora None, significa che è la prima mail che incontriamo.
              Quindi, l'autore della primissima mail verrà considerato l'opener del ticket'''
              opener = author
                            
            if author == opener:
              who = 'user'
            else:
              who = 'support'            

        message_stanza = div.find('div', class_='message-stanza')   
        if message_stanza:
          cutoff_element = message_stanza.find('div', class_='message-stanza-folder')

          if cutoff_element:
            desired_text = ''
            for elem in message_stanza.children:
                if elem == cutoff_element:
                    break
                if isinstance(elem, str):
                    desired_text += elem.strip() + ' '
                else:
                    desired_text += elem.get_text(separator=' ', strip=True) + ' '
        else:
            desired_text = message_stanza.get_text(separator=' ', strip=True)

        message_text = desired_text.strip() 
            
        if last_time_email:
          time_diff = compute_date_difference(date, last_time_email)
        else:
          time_diff = None    
        
        another_email_dict = {'@@ID_email': email_id,
                      '@@Date': date,
                      '@@To': from_ if who=='support' else to,
                      '@@Who': who,
                      '@@Author_Name': Author, #to if who=='support' else from_, # si chiamava From
                      '@@Author_username': Username, # questo è nuovo 
                      '@@Author_email': from_email, # si chiamava Email_author
                      '@@Subject': subject,
                      '@@Length_mail': len(message_text),
                      '@@Taken_by': taken_by,
                      '@@Status': current_status,
                      '@@Time_from_previous': time_diff,
                      '@@Body': remove_endings(message_text),
                      }
        emails.append(another_email_dict)    
        
        email_id += 1
        last_time_email = date
  
  if len(emails) > 0: # necessario perché alcune email sono vuote
    emails[-1]['@@Status'] = current_status # se dopo l'ultima mail inviata lo status viene modificato, così almeno siamo in grado di riconoscerlo
    for i in range(1, len(emails)):
      emails[i]['@@Taken_by'] = taken_by

  return(emails)

## Se vuoi provare extract_email sulla singola mail, runna questo codice:
# extracted = extract_emails(html_content)    
# for extr in extracted:
#   print(extr); print('')

# src_folder = '/leonardo_work/try24_facchian/tts_tickets'
# for filename in os.listdir(src_folder)[179:185]:
#     if filename.endswith('.log'):
#         file_path = os.path.join(src_folder, filename)
#         with open(file_path, 'r') as file:
#             html_content = file.read()
        
#         extracted = extract_emails(html_content)
#         for extr in extracted:
#             print(extr)
#             print('')

         


def extract_ticket_number(name_log):
    number = name_log[7:14]
    return number


def create_dataset(source_folder, destination_folder, save_as, save_only_part = None, display = False, show_entries = None, save = True):
  '''
  This function creates the JSON dataset that will eventually be fed to the LLM.
  Each entry of the dataset is one ticket. Specifically, each ticket consists in:
  - Metadata of the ticket
  - Emails, and metadata of the emails
  
  -> source_folder tells you where are the raw HTMLs
  -> destination_folder tells you where you want to save the dataset
  -> save_as is a parameter you can set to decide the name of the JSON file
  -> save_only_part is set if you only want to process N HTMLs from the source_folder
  -> display is a bool. If True, it prints the first "show_entries" entries
  -> save is a bool. If true, it saves
  '''
  
  log_files = sorted([f for f in os.listdir(source_folder) if f.endswith('.log')]) # sorted files in source_folder 
  tickets = [] # initialize an empy list. This will be filled with the tickets
  
  if save_only_part:
    # If asked, it only processed the irst N files from source_folder
    log_files = log_files[:save_only_part]
    
  if show_entries:
    log_files = log_files[:show_entries]
    
  n_files = len(log_files)  
  
  
  for file_idx, filename in enumerate(log_files):
    if file_idx % 500 == 0:
      print(f"\nProcessing file n. {file_idx} of {n_files}...")
    
    ticket_id = extract_ticket_number(filename)
    file_path = os.path.join(source_folder, filename)

    try: 
      with open(file_path, 'r') as file:
        html_content = file.read()
        extracted_emails = extract_emails(html_content) # parsing of the email

        # Creating metadata of the entire ticket
        if extracted_emails:
          len_ticket = len(extracted_emails) # total number of emails in the ticket
          open_date = extracted_emails[0]['@@Date'] # opening date of the ticket
          close_date = extracted_emails[-1]['@@Date'] # closure date of the ticket
          date_diff = compute_date_difference(open_date, close_date) # duration of the ticket
          opener_ticket = extracted_emails[0]['@@Author_Name'] # name of the opener (user)
          taken_by_operator = extracted_emails[-1]['@@Taken_by'] # name of the operator who took the ticket
          last_status = extracted_emails[-1]['@@Status'] # final status of the ticket: can be new (never opened), open, resolved
          subject_ticket = extracted_emails[0]['@@Subject'] # subject of the ticket
          email_author = extracted_emails[0]['@@Author_email']
          
        else:
          # We need this else because for the moment some tickets cannot be parsed (errors, mesages too long...)
          len_ticket = 0  
          open_date = None
          close_date = None
          date_diff = 0
          opener_ticket = None
          taken_by_operator = None
          last_status = None
          subject_ticket = None   
    
    except Exception as e:
      print(f"Error processing ticket ID {ticket_id}: {str(e)}")
          
    
    # Sometimes we don't have access to the name of the user, but only to his/her email.
    # This is a problem because we can't anonymize the data effectively. So, we double check
    # whether we have accesso to an email in the form: name.surname@domain.com.
    # We try to extract the name from here
    if opener_ticket:
      if check_if_email(opener_ticket):
        pattern = r'([a-zA-Z]+)\.([a-zA-Z]+)@'
        match = re.match(pattern, opener_ticket)
        if match:
          opener_ticket = f'{match.group(1)} {match.group(2)}'  
        
    ticket_dictionary = {
      '**ID_ticket': ticket_id, # ID del ticket
      '**Open_date_ticket': open_date, # Open date del ticket
      '**Closure_Date_ticke': close_date, # Closure date del ticket
      '**Duration_ticket': date_diff, # Lunghezza temporale del ticket
      '**Opener_ticket': opener_ticket, # Nome della persone che ha aperto il ticket
      '**Status_ticket': last_status, # Status del ticket
      '**Languages_ticket': ['Not yet assigned'], # Lingue usate nel ticket
      '**Length_ticket': len_ticket, # Numero di mail del ticket
      '**Email_author': email_author, 
      '**Subject_ticket': subject_ticket, # Oggetto del ticket
      '**Taken_by_ticket': taken_by_operator, # Chi ha preso in carico il ticket
      '**Emails_ticket': extracted_emails # Lista di email del ticket
    }
      
    # Anonymize  
    ticket_dictionary = consistent_anonimization(ticket_dictionary)  
    
    # Add to the dataset
    tickets.append(ticket_dictionary)   
    
  if display:
    if show_entries:
      print(tickets[:show_entries])   
    else:
      print(tickets)
    
  if save:
    # Saving details:
    if not save_as.endswith('.json'):
      save_as += '.json' # add .jons to the file name
    full_path = os.path.join(destination_folder, save_as)  
    
    print(f"\n*** Saving in: {full_path} ***")  
    
    with open(full_path, 'w') as file:
      json.dump(tickets, file, indent=4) # 'indent=4' to make the file more readable
    
    if os.path.exists(full_path):
      print("\n*** File saved successfully ***\n")
    else:
      print("\n*** Failed to save the file: file already present ***\n")  
    
  
  return('Saving complete')

  
  # print(f"Saving to: {full_path}")  
  # with open(full_path, 'w') as file:
  #     json.dump(tickets, file, indent=4)  # 'indent=4' to make the file more readable
  # if os.path.exists(full_path):
  #   print("File saved successfully.")
  # else:
  #   print("Failed to save the file.") 


create_dataset(source_folder = '/leonardo_work/try24_facchian/tts_tickets',
               destination_folder = '/leonardo_work/try24_facchian/datasets_json',
               save_as = 'anonymized_dataset_v3', #anonymized_dataset_v3 <-- dovrebbe essere l'ultima versione con 4000 tickets
               display = False,
               save_only_part = 20000,
               save = True)